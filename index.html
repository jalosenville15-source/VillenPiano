<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Villen Piano</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: auto;
    background: #001f3f;
    position: relative;
  }

  header {
    font-size: 3rem;
    margin: 1rem 0;
    font-weight: bold;
    color: #00ffff;
    text-shadow: 0 0 15px #00ffff;
    z-index: 10;
    position: relative;
  }

  /* Valuva tausta */
  .background {
    position: fixed;
    inset: 0;
    z-index: 0;
    background: linear-gradient(270deg, #001f3f, #003366, #004080, #001f3f);
    background-size: 800% 800%;
    animation: gradientMove 15s ease infinite;
  }

  @keyframes gradientMove {
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }

  .piano {
    display: flex;
    position: relative;
    margin: 1rem 0;
    z-index: 1;
  }

  .white-key, .black-key {
    border: 1px solid #555;
    border-radius: 0 0 5px 5px;
    cursor: pointer;
    position: relative;
    user-select: none;
  }

  .white-key {
    width: 40px;
    height: 200px;
    background: white;
    margin: 0 1px;
    z-index: 1;
  }

  .black-key {
    width: 28px;
    height: 120px;
    background: black;
    position: absolute;
    z-index: 2;
    margin-left: -14px;
  }

  .key-active {
    transform: scale(0.95);
    box-shadow: 0 0 15px cyan;
  }

  .controls {
    margin: 1rem 0;
    display: flex;
    gap: 1rem;
    z-index: 1;
    position: relative;
  }

  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:active {
    transform: scale(0.95);
  }

  .sustain, .mute {
    background: #00cccc;
    color: black;
    text-shadow: none;
  }

</style>
</head>
<body>
<div class="background"></div>
<header>Villen Piano</header>

<div class="piano" id="piano"></div>

<div class="controls">
  <button id="sustain" class="sustain">Sustain (SPACE)</button>
  <button id="mute" class="mute">Ääni päällä</button>
</div>

<script>
const keys = [
  { key: 'C3', freq: 130.81, color:'white', keyboard:'z' },
  { key: 'C#3', freq:138.59, color:'black', keyboard:'s' },
  { key: 'D3', freq:146.83, color:'white', keyboard:'x' },
  { key: 'D#3', freq:155.56, color:'black', keyboard:'d' },
  { key: 'E3', freq:164.81, color:'white', keyboard:'c' },
  { key: 'F3', freq:174.61, color:'white', keyboard:'v' },
  { key: 'F#3', freq:185, color:'black', keyboard:'g' },
  { key: 'G3', freq:196, color:'white', keyboard:'b' },
  { key: 'G#3', freq:207.65, color:'black', keyboard:'h' },
  { key: 'A3', freq:220, color:'white', keyboard:'n' },
  { key: 'A#3', freq:233.08, color:'black', keyboard:'j' },
  { key: 'B3', freq:246.94, color:'white', keyboard:'m' },
  { key: 'C4', freq:261.63, color:'white', keyboard:'q' },
  { key: 'C#4', freq:277.18, color:'black', keyboard:'2' },
  { key: 'D4', freq:293.66, color:'white', keyboard:'w' },
  { key: 'D#4', freq:311.13, color:'black', keyboard:'3' },
  { key: 'E4', freq:329.63, color:'white', keyboard:'e' },
  { key: 'F4', freq:349.23, color:'white', keyboard:'r' },
  { key: 'F#4', freq:369.99, color:'black', keyboard:'5' },
  { key: 'G4', freq:392, color:'white', keyboard:'t' },
  { key: 'G#4', freq:415.3, color:'black', keyboard:'6' },
  { key: 'A4', freq:440, color:'white', keyboard:'y' },
  { key: 'A#4', freq:466.16, color:'black', keyboard:'7' },
  { key: 'B4', freq:493.88, color:'white', keyboard:'u' },
  { key: 'C5', freq:523.25, color:'white', keyboard:'i' },
  { key: 'C#5', freq:554.37, color:'black', keyboard:'9' },
  { key: 'D5', freq:587.33, color:'white', keyboard:'o' },
  { key: 'D#5', freq:622.25, color:'black', keyboard:'0' },
  { key: 'E5', freq:659.25, color:'white', keyboard:'p' },
  { key: 'F5', freq:698.46, color:'white', keyboard:'å' }
];

const pianoDiv = document.getElementById('piano');
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const activeOsc = new Map();
let sustain = false;
let muted = false;

// Render keys
keys.forEach((k,i) => {
  const btn = document.createElement('div');
  btn.classList.add(k.color === 'white' ? 'white-key' : 'black-key');
  btn.dataset.key = k.key;

  // black key positions
  if(k.color==='black') {
    const left = Array.from(pianoDiv.children).filter(x=>x.classList.contains('white-key')).length;
    btn.style.left = `${left*41-14}px`;
  }

  pianoDiv.appendChild(btn);

  btn.addEventListener('mousedown', () => pressKey(k));
  btn.addEventListener('mouseup', () => releaseKey(k));
  btn.addEventListener('mouseleave', () => releaseKey(k));
});

function playSound(freq) {
  if (muted) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = freq;
  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.6, audioCtx.currentTime+0.01);
  gain.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.15);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  return {osc, gain};
}

function pressKey(k) {
  if (!activeOsc.has(k.key)) {
    const sound = playSound(k.freq);
    activeOsc.set(k.key, sound);
    const btn = pianoDiv.querySelector(`[data-key='${k.key}']`);
    btn?.classList.add('key-active');
  }
}

function releaseKey(k) {
  if (!sustain && activeOsc.has(k.key)) {
    const {osc, gain} = activeOsc.get(k.key);
    const now = audioCtx.currentTime;
    gain.gain.cancelScheduledValues(now);
    gain.gain.setValueAtTime(gain.gain.value, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now+0.2);
    setTimeout(()=>{try{osc.stop()}catch(e){}}, 200);
    activeOsc.delete(k.key);
    const btn = pianoDiv.querySelector(`[data-key='${k.key}']`);
    btn?.classList.remove('key-active');
  }
}

// Keyboard events
const pressedKeys = new Set();
window.addEventListener('keydown', e => {
  if(e.code==='Space'){ sustain=true; return; }
  if(pressedKeys.has(e.key)) return;
  pressedKeys.add(e.key);
  const k = keys.find(k=>k.keyboard===e.key.toLowerCase());
  if(k) pressKey(k);
});
window.addEventListener('keyup', e => {
  if(e.code==='Space'){ sustain=false; activeOsc.forEach((_,k)=>releaseKey(keys.find(x=>x.key===k))); return; }
  pressedKeys.delete(e.key);
  const k = keys.find(k=>k.keyboard===e.key.toLowerCase());
  if(k) releaseKey(k);
});

// Controls
document.getElementById('sustain').addEventListener('click', ()=>sustain=!sustain);
document.getElementById('mute').addEventListener('click', ()=>{
  muted = !muted;
  document.getElementById('mute').textContent = muted?'Ääni pois':'Ääni päällä';
  if(muted) activeOsc.forEach((_,k)=>releaseKey(keys.find(x=>x.key===k)));
});
</script>
</body>
</html>
