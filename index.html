<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Villen Piano</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: sans-serif;
    background: #001f3f;
  }
  #title {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    font-size: 5em;
    color: #0ff;
    text-shadow: 0 0 20px #0ff, 0 0 40px #0ff, 0 0 60px #0ff;
    z-index: 2;
  }
  #piano {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    z-index: 2;
  }
  .key {
    width: 70px;
    height: 300px;
    border: 1px solid #000;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    font-size: 16px;
    color: #000;
    user-select: none;
    margin: 2px;
  }
  .white { background: #fff; z-index: 1; }
  .black { 
    background: #000; 
    width: 45px; 
    height: 200px; 
    margin-left: -22px; 
    margin-right: -22px;
    color: #0ff;
    z-index: 2;
  }
  .active { transform: scaleY(0.9); box-shadow: 0 0 15px #0ff; }
  canvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
</style>
</head>
<body>
<div id="title">Villen Piano</div>
<canvas id="bg"></canvas>
<div id="piano"></div>

<script>
const keys = [
  {note:"C3", freq:130.81},{note:"C#3", freq:138.59},{note:"D3", freq:146.83},
  {note:"D#3", freq:155.56},{note:"E3", freq:164.81},{note:"F3", freq:174.61},
  {note:"F#3", freq:185.00},{note:"G3", freq:196.00},{note:"G#3", freq:207.65},
  {note:"A3", freq:220.00},{note:"A#3", freq:233.08},{note:"B3", freq:246.94},
  {note:"C4", freq:261.63},{note:"C#4", freq:277.18},{note:"D4", freq:293.66},
  {note:"D#4", freq:311.13},{note:"E4", freq:329.63},{note:"F4", freq:349.23},
  {note:"F#4", freq:369.99},{note:"G4", freq:392.00},{note:"G#4", freq:415.30},
  {note:"A4", freq:440.00},{note:"A#4", freq:466.16},{note:"B4", freq:493.88},
  {note:"C5", freq:523.25},{note:"C#5", freq:554.37},{note:"D5", freq:587.33},
  {note:"D#5", freq:622.25},{note:"E5", freq:659.25},{note:"F5", freq:698.46}
];

const piano = document.getElementById('piano');
const activeKeys = new Set();
let sustain = false;

const AudioCtx = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioCtx();

function createOscillator(freq) {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(ctx.destination);
  gain.gain.setValueAtTime(0, ctx.currentTime);
  return {osc, gain};
}

const notesMap = new Map();

function playNote(note) {
  if(notesMap.has(note.note)) return;
  const {osc, gain} = createOscillator(note.freq);
  osc.start();
  gain.gain.linearRampToValueAtTime(0.6, ctx.currentTime + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.2);
  notesMap.set(note.note, {osc, gain});
  activeKeys.add(note.note);
}

function stopNote(note) {
  if(!notesMap.has(note.note)) return;
  const {osc, gain} = notesMap.get(note.note);
  if(!sustain){
    gain.gain.cancelScheduledValues(ctx.currentTime);
    gain.gain.setValueAtTime(gain.gain.value, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    setTimeout(()=>osc.stop(), 500);
    notesMap.delete(note.note);
    activeKeys.delete(note.note);
  }
}

document.addEventListener('keydown', e=>{
  if(e.code==="Space"){ sustain=true; }
});
document.addEventListener('keyup', e=>{
  if(e.code==="Space"){ sustain=false; activeKeys.forEach(k=>stopNote({note:k})); }
});

keys.forEach(k=>{
  const el = document.createElement('div');
  el.className = k.note.includes('#')?"key black":"key white";
  el.innerHTML = k.note;
  piano.appendChild(el);
  el.addEventListener('mousedown', ()=>{ 
    playNote(k); 
    el.classList.add('active'); 
  });
  el.addEventListener('mouseup', ()=>{ 
    stopNote(k); el.classList.remove('active'); 
  });
  el.addEventListener('mouseleave', ()=>{ 
    stopNote(k); el.classList.remove('active'); 
  });
});

// Animated blue balls falling (fewer, bigger)
const canvas = document.getElementById('bg');
const c = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let balls = [];
for(let i=0;i<15;i++){
  balls.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    r:Math.random()*50+30,
    dy:Math.random()*0.5+0.2,
    color:`rgba(0, ${Math.floor(Math.random()*255)}, 255,0.4)`
  });
}

function animate(){
  c.clearRect(0,0,canvas.width,canvas.height);
  balls.forEach(b=>{
    b.y += b.dy;
    if(b.y>canvas.height) b.y=0;
    c.beginPath();
    c.arc(b.x,b.y,b.r,0,Math.PI*2);
    c.fillStyle = b.color;
    c.fill();
  });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>


